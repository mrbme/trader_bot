<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crypto Vol Bot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
      @theme {
        --color-gh-bg: #0d1117;
        --color-gh-card: #161b22;
        --color-gh-border: #30363d;
        --color-gh-border-subtle: #21262d;
        --color-gh-text: #c9d1d9;
        --color-gh-muted: #8b949e;
        --color-gh-dimmed: #484f58;
        --color-gh-blue: #58a6ff;
        --color-gh-green: #3fb950;
        --color-gh-red: #f85149;
        --color-gh-yellow: #d29922;
        --color-gh-purple: #bc8cff;
        --color-gh-cyan: #79c0ff;
        --color-gh-btn: #21262d;
        --color-gh-btn-hover: #30363d;
      }
    </style>
    <style>
      .fg-gauge {
        background: linear-gradient(to right, #f85149, #d29922, #3fb950);
      }
    </style>
  </head>
  <body class="bg-gh-bg text-gh-text p-5 max-w-[1200px] mx-auto" style="font-family: 'Press Start 2P', cursive;">
    <h1 class="text-gh-blue mb-2 text-[1.4rem] font-bold">Crypto Volatility Bot</h1>
    <p class="text-gh-muted mb-6 text-sm">Bollinger Band Mean Reversion + RSI | Paper Trading</p>

    <div class="flex gap-3 mb-4">
      <button class="px-5 py-2 border border-gh-yellow text-gh-yellow rounded-md bg-gh-btn hover:bg-[#2d2a0f] text-sm font-mono cursor-pointer transition-colors" id="pauseBtn" onclick="togglePause()">Pause Bot</button>
      <button class="px-5 py-2 border border-gh-red text-gh-red rounded-md bg-gh-btn hover:bg-[#3d1116] text-sm font-mono cursor-pointer transition-colors" id="liquidateBtn" onclick="liquidateAll()">Liquidate All</button>
      <button class="px-5 py-2 border border-gh-border rounded-md bg-gh-btn hover:bg-gh-btn-hover text-sm font-mono cursor-pointer transition-colors ml-auto" onclick="logout()">Logout</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <!-- Account -->
      <div class="bg-gh-card border border-gh-border rounded-lg p-4">
        <h2 class="text-gh-blue text-[0.95rem] font-bold mb-3 pb-2 border-b border-gh-border-subtle">Account</h2>
        <div id="account">
          <div class="flex justify-between py-1.5 border-b border-gh-border-subtle">
            <span class="text-gh-muted">Equity</span><span class="font-semibold" id="equity">--</span>
          </div>
          <div class="flex justify-between py-1.5 border-b border-gh-border-subtle">
            <span class="text-gh-muted">Cash</span><span class="font-semibold" id="cash">--</span>
          </div>
          <div class="flex justify-between py-1.5">
            <span class="text-gh-muted">Status</span><span class="font-semibold" id="botStatus">--</span>
          </div>
        </div>
      </div>

      <!-- Positions -->
      <div class="bg-gh-card border border-gh-border rounded-lg p-4">
        <h2 class="text-gh-blue text-[0.95rem] font-bold mb-3 pb-2 border-b border-gh-border-subtle">Positions</h2>
        <table class="w-full border-collapse text-sm">
          <thead>
            <tr>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Symbol</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Qty</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Value</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">P&L</th>
            </tr>
          </thead>
          <tbody id="positions">
            <tr><td colspan="4" class="py-2 px-1.5">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Market Regime -->
      <div class="bg-gh-card border border-gh-border rounded-lg p-4">
        <h2 class="text-gh-blue text-[0.95rem] font-bold mb-3 pb-2 border-b border-gh-border-subtle">Market Regime</h2>
        <div id="regime"><span class="text-gh-dimmed italic">Loading...</span></div>
      </div>

      <!-- Fear & Greed -->
      <div class="bg-gh-card border border-gh-border rounded-lg p-4">
        <h2 class="text-gh-blue text-[0.95rem] font-bold mb-3 pb-2 border-b border-gh-border-subtle">Fear &amp; Greed Index</h2>
        <div id="fearGreed"><span class="text-gh-dimmed italic">Loading...</span></div>
      </div>

      <!-- Funding Rates -->
      <div class="bg-gh-card border border-gh-border rounded-lg p-4 col-span-full">
        <h2 class="text-gh-blue text-[0.95rem] font-bold mb-3 pb-2 border-b border-gh-border-subtle">Funding Rates</h2>
        <div id="fundingRates"><span class="text-gh-dimmed italic">Loading...</span></div>
      </div>

      <!-- Signals -->
      <div class="bg-gh-card border border-gh-border rounded-lg p-4 col-span-full">
        <h2 class="text-gh-blue text-[0.95rem] font-bold mb-3 pb-2 border-b border-gh-border-subtle">Signals</h2>
        <table class="w-full border-collapse text-sm">
          <thead>
            <tr>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Symbol</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Price</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">RSI</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">BB Lower</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">BB Upper</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Signal</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Sentiment</th>
            </tr>
          </thead>
          <tbody id="signals">
            <tr><td colspan="7" class="py-2 px-1.5">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Recent Trades -->
      <div class="bg-gh-card border border-gh-border rounded-lg p-4 col-span-full">
        <h2 class="text-gh-blue text-[0.95rem] font-bold mb-3 pb-2 border-b border-gh-border-subtle">Recent Trades</h2>
        <div class="max-h-[300px] overflow-y-auto">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Time</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Symbol</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Side</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Amount</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Price</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Reason</th>
              </tr>
            </thead>
            <tbody id="trades">
              <tr><td colspan="6" class="py-2 px-1.5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Trade Journal -->
      <div class="bg-gh-card border border-gh-border rounded-lg p-4 col-span-full">
        <h2 class="text-gh-blue text-[0.95rem] font-bold mb-3 pb-2 border-b border-gh-border-subtle">Trade Journal</h2>
        <div class="max-h-[400px] overflow-y-auto">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Time</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Symbol</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Side</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Price</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Notional</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Regime</th>
                <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">LLM Analysis</th>
              </tr>
            </thead>
            <tbody id="journal">
              <tr><td colspan="7" class="py-2 px-1.5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <p class="text-gh-dimmed text-xs mt-2" id="lastUpdate"></p>

    <script>
      let enrichmentData = null;

      // --- Helpers ---
      const fgColor = (val) => {
        if (val <= 25) return '#f85149';
        if (val <= 45) return '#d29922';
        if (val <= 55) return '#8b949e';
        if (val <= 75) return '#d29922';
        return '#3fb950';
      };

      const regimeStyle = (regime) => {
        const map = {
          'trending-up':          { bg: '#0d3320', color: '#3fb950' },
          'trending-down':        { bg: '#3d1116', color: '#f85149' },
          'range-bound':          { bg: '#2d2a0f', color: '#d29922' },
          'volatile-expansion':   { bg: '#2a1a3e', color: '#bc8cff' },
          'volatile-compression': { bg: '#0d2a3d', color: '#79c0ff' },
        };
        return map[regime] || { bg: '#21262d', color: '#8b949e' };
      };

      const sentimentDot = (val) => {
        if (val == null) return '<span class="text-gh-dimmed">--</span>';
        const color = val > 0.3 ? '#3fb950' : val < -0.3 ? '#f85149' : '#d29922';
        return `<span class="inline-block w-2 h-2 rounded-full mr-1 align-middle" style="background:${color}"></span>${val.toFixed(2)}`;
      };

      const badgeHtml = (action) => {
        const cls = action === 'buy'
          ? 'bg-[#0d3320] text-[#3fb950]'
          : action === 'sell'
            ? 'bg-[#3d1116] text-[#f85149]'
            : 'bg-[#2d2a0f] text-[#d29922]';
        return `<span class="inline-block px-2 py-0.5 rounded-full text-xs font-semibold uppercase ${cls}">${action}</span>`;
      };

      const escHtml = (str) => {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
      };

      // --- Enrichment ---
      const fetchEnrichment = async () => {
        try {
          const res = await fetch('/api/enrichment');
          const data = await res.json();
          enrichmentData = data.enrichment;
          renderEnrichment(enrichmentData);
        } catch (err) {
          console.error('Failed to fetch enrichment', err);
        }
      };

      const renderEnrichment = (e) => {
        // Fear & Greed
        const fgEl = document.getElementById('fearGreed');
        if (!e || !e.fearGreed) {
          fgEl.innerHTML = '<span class="text-gh-dimmed italic">No Fear &amp; Greed data available</span>';
        } else {
          const fg = e.fearGreed;
          const color = fgColor(fg.value);
          const pct = Math.max(0, Math.min(100, fg.value));
          fgEl.innerHTML = `
            <div class="text-center text-[1.8rem] font-bold my-2" style="color:${color}">${fg.value}</div>
            <div class="text-center text-xs font-semibold uppercase mb-3" style="color:${color}">${escHtml(fg.classification)}</div>
            <div class="relative h-2 rounded-full fg-gauge">
              <div class="absolute -top-1 w-4 h-4 rounded-full bg-gh-text border-2 border-gh-bg -translate-x-1/2" style="left:${pct}%"></div>
            </div>
            <div class="flex justify-between text-[0.7rem] text-gh-muted mt-1">
              <span>Extreme Fear</span><span>Neutral</span><span>Extreme Greed</span>
            </div>`;
        }

        // Market Regime
        const regEl = document.getElementById('regime');
        if (!e || !e.regime) {
          regEl.innerHTML = '<span class="text-gh-dimmed italic">No regime classification available</span>';
        } else {
          const rs = regimeStyle(e.regime);
          let html = `<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold uppercase" style="background:${rs.bg};color:${rs.color}">${escHtml(e.regime)}</span>`;
          if (e.regimeConfidence != null) {
            const pct = Math.round(e.regimeConfidence * 100);
            html += `
              <div class="flex justify-between text-gh-muted text-xs mt-3">
                <span>Confidence</span><span>${pct}%</span>
              </div>
              <div class="h-1 rounded bg-gh-border-subtle mt-1.5">
                <div class="h-full rounded bg-gh-blue transition-all duration-300" style="width:${pct}%"></div>
              </div>`;
          }
          if (e.timestamp) {
            html += `<div class="text-gh-dimmed text-xs mt-3">Updated: ${new Date(e.timestamp).toLocaleTimeString()}</div>`;
          }
          regEl.innerHTML = html;
        }

        // Funding Rates
        const frEl = document.getElementById('fundingRates');
        if (!e || !e.fundingRates || e.fundingRates.length === 0) {
          frEl.innerHTML = '<span class="text-gh-dimmed italic">No funding rate data</span>';
        } else {
          const rows = e.fundingRates.map((f) => {
            const rate = f.fundingRate;
            const annualized = rate * 3 * 365 * 100;
            const rateColor = Math.abs(rate) < 0.0001 ? 'text-gh-muted' : rate > 0 ? 'text-[#3fb950]' : 'text-[#f85149]';
            const annColor = Math.abs(annualized) < 0.5 ? 'text-gh-muted' : annualized > 0 ? 'text-[#3fb950]' : 'text-[#f85149]';
            const next = f.nextFundingTime ? new Date(f.nextFundingTime).toLocaleTimeString() : '--';
            return `<tr>
              <td class="py-2 px-1.5 border-b border-gh-border-subtle">${escHtml(f.symbol)}</td>
              <td class="py-2 px-1.5 border-b border-gh-border-subtle ${rateColor}">${(rate * 100).toFixed(4)}%</td>
              <td class="py-2 px-1.5 border-b border-gh-border-subtle ${annColor}">${annualized.toFixed(2)}%</td>
              <td class="py-2 px-1.5 border-b border-gh-border-subtle">$${Number(f.markPrice).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
              <td class="py-2 px-1.5 border-b border-gh-border-subtle">${next}</td>
            </tr>`;
          }).join('');
          frEl.innerHTML = `<table class="w-full border-collapse text-sm">
            <thead><tr>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Symbol</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Rate (%)</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">8h Annualized (%)</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Mark Price</th>
              <th class="text-left text-gh-muted py-2 px-1.5 border-b border-gh-border font-medium">Next Funding</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
        }
      };

      // --- Journal ---
      const fetchJournal = async () => {
        try {
          const res = await fetch('/api/journal?limit=50');
          const data = await res.json();
          renderJournal(data.entries);
        } catch (err) {
          console.error('Failed to fetch journal', err);
        }
      };

      const renderJournal = (entries) => {
        const tbody = document.getElementById('journal');
        if (!entries || entries.length === 0) {
          const msg = enrichmentData === null ? 'Loading...' : 'No journal entries yet';
          tbody.innerHTML = `<tr><td colspan="7" class="py-2 px-1.5 text-gh-dimmed italic">${msg}</td></tr>`;
          return;
        }

        tbody.innerHTML = entries.slice().reverse().map((e, i) => {
          const sideClass = e.side === 'buy' ? 'bg-[#0d3320] text-[#3fb950]' : 'bg-[#3d1116] text-[#f85149]';
          const regBadge = e.regime
            ? (() => { const rs = regimeStyle(e.regime); return `<span class="inline-block px-2 py-0.5 rounded-full text-xs font-semibold uppercase" style="background:${rs.bg};color:${rs.color}">${escHtml(e.regime)}</span>`; })()
            : '<span class="text-gh-dimmed">--</span>';

          const analysis = e.llmAnalysis || '';
          const truncated = analysis.length > 120 ? escHtml(analysis.slice(0, 120)) + '...' : escHtml(analysis);
          const hasMore = analysis.length > 120;
          const analysisCell = analysis
            ? `${truncated}${hasMore ? ` <button class="text-gh-blue text-xs bg-transparent border-none cursor-pointer font-mono hover:underline p-0" onclick="toggleJournalRow(${i})">more</button>` : ''}`
            : '<span class="text-gh-dimmed italic">LLM disabled</span>';

          const detailHtml = analysis ? `
            <tr id="journal-detail-${i}" class="hidden">
              <td colspan="7" class="p-3 bg-gh-bg text-sm leading-relaxed text-gh-muted border-b border-gh-border-subtle">
                <strong class="text-gh-text">Analysis:</strong> ${escHtml(analysis)}<br/><br/>
                ${e.marketContext ? `<strong class="text-gh-text">Market Context:</strong> ${escHtml(e.marketContext)}<br/><br/>` : ''}
                ${e.sentiment != null ? `<strong class="text-gh-text">Sentiment:</strong> ${e.sentiment.toFixed(2)}<br/>` : ''}
                ${e.fearGreed != null ? `<strong class="text-gh-text">Fear &amp; Greed:</strong> ${e.fearGreed}<br/>` : ''}
              </td>
            </tr>` : '';

          return `<tr>
            <td class="py-2 px-1.5 border-b border-gh-border-subtle">${new Date(e.timestamp).toLocaleString()}</td>
            <td class="py-2 px-1.5 border-b border-gh-border-subtle">${escHtml(e.symbol)}</td>
            <td class="py-2 px-1.5 border-b border-gh-border-subtle"><span class="inline-block px-2 py-0.5 rounded-full text-xs font-semibold uppercase ${sideClass}">${e.side}</span></td>
            <td class="py-2 px-1.5 border-b border-gh-border-subtle">$${Number(e.price).toFixed(2)}</td>
            <td class="py-2 px-1.5 border-b border-gh-border-subtle">$${Number(e.notional).toFixed(2)}</td>
            <td class="py-2 px-1.5 border-b border-gh-border-subtle">${regBadge}</td>
            <td class="py-2 px-1.5 border-b border-gh-border-subtle max-w-[250px]">${analysisCell}</td>
          </tr>${detailHtml}`;
        }).join('');
      };

      const toggleJournalRow = (idx) => {
        const row = document.getElementById(`journal-detail-${idx}`);
        if (row) row.classList.toggle('hidden');
      };

      // --- Status ---
      const fetchStatus = async () => {
        try {
          const res = await fetch('/api/status');
          const data = await res.json();

          document.getElementById('equity').textContent = '$' + Number(data.equity).toFixed(2);
          document.getElementById('cash').textContent = '$' + Number(data.cash).toFixed(2);

          const statusEl = document.getElementById('botStatus');
          if (data.paused) {
            statusEl.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-gh-yellow mr-1.5"></span>Paused';
            document.getElementById('pauseBtn').textContent = 'Resume Bot';
          } else {
            statusEl.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-gh-green mr-1.5"></span>Running';
            document.getElementById('pauseBtn').textContent = 'Pause Bot';
          }

          const posBody = document.getElementById('positions');
          if (data.positions.length === 0) {
            posBody.innerHTML = '<tr><td colspan="4" class="py-2 px-1.5 text-gh-dimmed">No positions</td></tr>';
          } else {
            posBody.innerHTML = data.positions.map((p) => {
              const pl = Number(p.unrealizedPl);
              const plClass = pl >= 0 ? 'text-gh-green' : 'text-gh-red';
              return `<tr>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">${p.symbol}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">${Number(p.qty).toFixed(6)}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">$${Number(p.marketValue).toFixed(2)}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle ${plClass}">$${pl.toFixed(2)}</td>
              </tr>`;
            }).join('');
          }

          const sigBody = document.getElementById('signals');
          if (data.signals.length === 0) {
            sigBody.innerHTML = '<tr><td colspan="7" class="py-2 px-1.5 text-gh-dimmed">Waiting for first tick...</td></tr>';
          } else {
            const sentiments = enrichmentData?.sentiments || {};
            sigBody.innerHTML = data.signals.map((s) => {
              const rsiClass = s.rsi < 30 ? 'text-gh-green' : s.rsi > 70 ? 'text-gh-red' : '';
              const sentVal = sentiments[s.symbol] ?? null;
              return `<tr>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">${s.symbol}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">$${Number(s.price).toFixed(2)}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle ${rsiClass}">${s.rsi.toFixed(1)}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">$${Number(s.bbLower).toFixed(2)}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">$${Number(s.bbUpper).toFixed(2)}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">${badgeHtml(s.action)}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">${sentimentDot(sentVal)}</td>
              </tr>`;
            }).join('');
          }

          document.getElementById('lastUpdate').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
        } catch (err) {
          console.error('Failed to fetch status', err);
        }
      };

      // --- Trades ---
      const fetchTrades = async () => {
        try {
          const res = await fetch('/api/trades');
          const data = await res.json();
          const tbody = document.getElementById('trades');

          if (data.trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="py-2 px-1.5 text-gh-dimmed">No trades yet</td></tr>';
          } else {
            tbody.innerHTML = data.trades.slice(-50).reverse().map((t) => {
              const sideClass = t.side === 'buy' ? 'bg-[#0d3320] text-[#3fb950]' : 'bg-[#3d1116] text-[#f85149]';
              return `<tr>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">${new Date(t.timestamp).toLocaleString()}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">${t.symbol}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle"><span class="inline-block px-2 py-0.5 rounded-full text-xs font-semibold uppercase ${sideClass}">${t.side}</span></td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">$${t.notional}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle">$${Number(t.price).toFixed(2)}</td>
                <td class="py-2 px-1.5 border-b border-gh-border-subtle max-w-[200px] overflow-hidden text-ellipsis">${t.reason}</td>
              </tr>`;
            }).join('');
          }
        } catch (err) {
          console.error('Failed to fetch trades', err);
        }
      };

      // --- Controls ---
      const togglePause = async () => {
        try {
          await fetch('/api/pause', { method: 'POST' });
          fetchStatus();
        } catch (err) {
          console.error('Failed to toggle pause', err);
        }
      };

      const liquidateAll = async () => {
        if (!confirm('Liquidate ALL positions? This cannot be undone.')) return;
        try {
          const res = await fetch('/api/liquidate', { method: 'POST' });
          const data = await res.json();
          alert(data.message || 'Liquidation submitted');
          fetchStatus();
        } catch (err) {
          console.error('Failed to liquidate', err);
        }
      };

      const logout = async () => {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      };

      // --- Init ---
      fetchEnrichment();
      fetchJournal();
      fetchStatus();
      fetchTrades();
      setInterval(() => {
        fetchEnrichment();
        fetchJournal();
        fetchStatus();
        fetchTrades();
      }, 10000);
    </script>
  </body>
</html>
